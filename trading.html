<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GRIDGOLDGO Terminal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        body { background-color: #1a1a1a; color: #eeeeee; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 15px; user-select: none;}
        .dash-container { background-color: #252525; border: 1px solid #444; padding: 20px; border-radius: 5px; max-width: 400px; margin: 0 auto; box-shadow: 0 4px 15px rgba(0,0,0,0.8);}
        .title { color: #FFD700; font-weight: bold; font-size: 1.3rem; text-align: center; margin-bottom: 5px; }
        .price-display { color: #00BFFF; font-weight: bold; font-size: 1.6rem; text-align: center; margin-bottom: 20px; text-shadow: 0 0 10px rgba(0, 191, 255, 0.4); font-family: 'Courier New', Courier, monospace;}
        .data-row { display: flex; justify-content: space-between; font-size: 1rem; margin-bottom: 5px; }
        .data-label { color: #dcdcdc; }
        .data-val { color: #ffffff; font-weight: 500; }
        .divider { border-bottom: 1px dashed #666; margin: 12px 0; }
        .text-green { color: #00FF00 !important; }
        .text-red { color: #FF4500 !important; }
        .btn-panel { display: flex; gap: 10px; margin-top: 20px; }
        .btn-custom { flex: 1; padding: 10px; font-weight: bold; border: none; border-radius: 3px; cursor: pointer; color: white; transition: 0.1s;}
        .btn-custom:active { transform: scale(0.95); }
        .btn-closeall { background-color: #FF0000; }
        .btn-run { background-color: #008000; }
        .btn-pause { background-color: #B22222; }
        .chart-box { background-color: #1e1e1e; border: 1px solid #333; border-radius: 5px; padding: 10px 5px 0px 5px; margin: 15px 0; }
    </style>
</head>
<body>

    <div class="dash-container">
        <div class="title">GRIDGOLDGO</div>
        <div class="price-display" id="v_price">XAUUSD: 0.00</div>

        <div class="data-row"><span class="data-label">Broker:</span><span class="data-val" id="v_broker">Loading...</span></div>
        <div class="data-row"><span class="data-label">ID:</span><span class="data-val" id="v_id">---</span></div>
        <div class="data-row"><span class="data-label">Balance:</span><span class="data-val" id="v_bal">0.00</span></div>
        <div class="data-row"><span class="data-label">Equity:</span><span class="data-val" id="v_eq">0.00</span></div>
        <div class="data-row"><span class="data-label">Profit (Now):</span><span class="data-val text-green" id="v_profnow">0.00 (0 ord)</span></div>

        <div class="chart-box">
            <div id="growthChart"></div>
        </div>

        <div class="data-row"><span class="data-label">Lots (Open):</span><span class="data-val" id="v_lotopen">0.00</span></div>
        <div class="data-row"><span class="data-label">Lots (Today):</span><span class="data-val" id="v_lottoday">0.00</span></div>
        <div class="data-row"><span class="data-label">Lots (Total):</span><span class="data-val" id="v_lottotal">0.00</span></div>

        <div class="divider"></div>

        <div class="data-row"><span class="data-label">Profit (Day):</span><span class="data-val" id="v_profday">0.00</span></div>
        <div class="data-row"><span class="data-label">Profit (Total):</span><span class="data-val" id="v_proftotal">0.00</span></div>

        <div class="divider"></div>

        <div class="data-row"><span class="data-label">DD (Now):</span><span class="data-val" id="v_ddnow">0.00 %</span></div>
        <div class="data-row"><span class="data-label">DD (Max):</span><span class="data-val" id="v_ddmax">0.00 %</span></div>

        <div class="btn-panel">
            <button class="btn-custom btn-closeall" onclick="sendCommand('CLOSE_ALL')">CLOSE ALL</button>
            <button class="btn-custom btn-run" id="btn_state" onclick="sendCommand('TOGGLE_RUN')">RUNNING</button>
        </div>
        
        <div style="text-align: center; color: #555; font-size: 0.7rem; margin-top: 15px;">
            <span id="v_time">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>
        </div>
    </div>

    <script>
        const FIREBASE_DATA = "https://mt5-dashboard-985da-default-rtdb.asia-southeast1.firebasedatabase.app/mt5_data.json";
        const FIREBASE_CMD = "https://mt5-dashboard-985da-default-rtdb.asia-southeast1.firebasedatabase.app/mt5_command.json";

        function fmt(num) { return parseFloat(num).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

        var chartOptions = {
            series: [{ name: 'Balance', data: [] }, { name: 'Equity', data: [] }],
            chart: { type: 'area', height: 180, toolbar: { show: false }, animations: { enabled: false } },
            colors: ['#008FFB', '#00E396'], 
            fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.4, opacityTo: 0.05, stops: [0, 100] } },
            dataLabels: { enabled: false },
            stroke: { curve: 'smooth', width: 2 },
            xaxis: { categories: [], labels: { show: false }, axisBorder: { show: false }, axisTicks: { show: false } },
            yaxis: { labels: { style: { colors: '#888' }, formatter: (val) => { return val.toFixed(0); } } },
            tooltip: { theme: 'dark' },
            grid: { borderColor: '#444', strokeDashArray: 3, padding: { top: -20, bottom: -10, left: 10 } },
            legend: { position: 'top', horizontalAlign: 'right', labels: { colors: '#fff' } }
        };
        var myChart = new ApexCharts(document.querySelector("#growthChart"), chartOptions);
        myChart.render();

        async function updateDashboard() {
            try {
                const res = await fetch(FIREBASE_DATA);
                const d = await res.json();
                if(!d) return;

                // üåü ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥
                if(d.xauusd_price) {
                    document.getElementById('v_price').innerText = "XAUUSD: " + fmt(d.xauusd_price);
                }

                document.getElementById('v_broker').innerText = d.broker;
                document.getElementById('v_id').innerText = d.id;
                document.getElementById('v_bal').innerText = fmt(d.balance);
                document.getElementById('v_eq').innerText = fmt(d.equity);
                
                const profNow = document.getElementById('v_profnow');
                profNow.innerText = `${fmt(d.profit_now)} (${d.ord_count} ord)`;
                profNow.className = d.profit_now < 0 ? "data-val text-red" : "data-val text-green";

                document.getElementById('v_lotopen').innerText = fmt(d.lots_open);
                document.getElementById('v_lottoday').innerText = fmt(d.lots_today);
                document.getElementById('v_lottotal').innerText = fmt(d.lots_total);
                document.getElementById('v_profday').innerText = fmt(d.prof_day);
                // üåü ‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡πä‡∏Å NaN ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å proftotal ‡πÄ‡∏õ‡πá‡∏ô prof_total)
                document.getElementById('v_proftotal').innerText = fmt(d.prof_total);
                
                document.getElementById('v_ddnow').innerText = fmt(d.dd_now) + " %";
                document.getElementById('v_ddmax').innerText = fmt(d.dd_max) + " %";

                const btnState = document.getElementById('btn_state');
                if(d.is_paused) {
                    btnState.innerText = "PAUSED"; btnState.className = "btn-custom btn-pause";
                } else {
                    btnState.innerText = "RUNNING"; btnState.className = "btn-custom btn-run";
                }

                document.getElementById('v_time').innerText = "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: " + d.timestamp;

                if (d.chart_data && d.chart_data.length > 0) {
                    let times = d.chart_data.map(item => item.time);
                    let bals = d.chart_data.map(item => item.bal);
                    let eqs = d.chart_data.map(item => item.eq);
                    
                    myChart.updateOptions({ xaxis: { categories: times } });
                    myChart.updateSeries([
                        { name: 'Balance', data: bals },
                        { name: 'Equity', data: eqs }
                    ]);
                }
            } catch (e) { console.log(e); }
        }

        async function sendCommand(actionType) {
            if(actionType === 'CLOSE_ALL') {
                if(!confirm("‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏û‡∏≠‡∏£‡πå‡∏ï ‡∏õ‡∏¥‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
            }
            await fetch(FIREBASE_CMD, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ action: actionType, ts: Date.now() })
            });
        }

        updateDashboard();
        setInterval(updateDashboard, 1500); 
    </script>
</body>
</html>