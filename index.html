<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</title>
    <link rel="apple-touch-icon" sizes="180x180" href="logo-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="logo-icon.png">
    <link rel="icon" type="image/png" href="logo-icon.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --shell-red: #DD1D21;
            --shell-yellow: #FBCE07;
            --bg-color: #F4F4F4;
            --line-green: #06C755;
            --telegram-blue: #2481CC;
        }
        
        body {
            font-family: 'Kanit', sans-serif;
            background-color: var(--bg-color);
            padding-bottom: 100px;
            -webkit-user-select: none;
            user-select: none;
            overscroll-behavior-y: none;
        }

        .navbar {
            background: linear-gradient(90deg, var(--shell-red) 0%, #C10510 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .navbar-brand { font-weight: bold; color: white !important; }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            overflow: hidden;
            background: white;
        }

        .summary-box {
            border-radius: 12px;
            padding: 15px 5px;
            color: white;
            text-align: center;
            height: 100%;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }
        .bg-budget { background: linear-gradient(135deg, #FFB700, #FF8C00); color: #333; }
        .bg-spent { background: linear-gradient(135deg, #DD1D21, #B71C1C); }
        .bg-remaining { background: linear-gradient(135deg, #2E7D32, #1B5E20); }

        .main-add-btn {
            background: white;
            color: var(--shell-red);
            border: 2px solid var(--shell-red);
            border-radius: 50px;
            padding: 12px;
            font-weight: bold;
            font-size: 1.1rem;
            width: 100%;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: all 0.2s;
        }
        .main-add-btn:active {
            background: var(--shell-red);
            color: white;
            transform: scale(0.98);
        }

        .category-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 6px solid var(--shell-yellow);
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .subcategory-item {
            background: #fffdf5;
            border-radius: 8px;
            padding: 12px;
            margin-top: 8px;
            margin-left: 5px;
            border-left: 3px solid var(--shell-red);
            font-size: 0.95rem;
        }
        
        .btn-delete-wrapper {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #fee;
            border-radius: 50%;
            color: #dc3545;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-delete-wrapper:active {
            background-color: #fcc;
            transform: scale(0.95);
        }

        .btn-report-line {
            background-color: var(--line-green);
            color: white;
            border: none;
        }
        .btn-report-tg {
            background-color: var(--telegram-blue);
            color: white;
            border: none;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark sticky-top">
        <div class="container">
            <span class="navbar-brand" id="brandName">
                <i class="fas fa-gas-pump me-2"></i>‡∏£‡∏∞‡∏ö‡∏ö‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì
            </span>
            <button class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#menuModal">
                <i class="fas fa-bars"></i> ‡πÄ‡∏°‡∏ô‡∏π
            </button>
        </div>
    </nav>

    <div class="container mt-3">
        <div class="d-flex justify-content-between align-items-center mb-3 bg-white p-3 rounded-4 shadow-sm">
            <button class="btn btn-light text-danger rounded-circle" id="prevMonth"><i class="fas fa-chevron-left"></i></button>
            <span class="fw-bold fs-5 text-dark" id="currentMonthYear">...</span>
            <button class="btn btn-light text-danger rounded-circle" id="nextMonth"><i class="fas fa-chevron-right"></i></button>
        </div>

        <div class="row mb-3 g-2">
            <div class="col-4">
                <div class="summary-box bg-budget">
                    <small style="opacity:0.9; font-size: 0.8rem;">‡∏á‡∏ö‡∏£‡∏ß‡∏°</small>
                    <div class="fw-bold mt-1" style="font-size: 0.9rem;" id="totalBudget">0</div>
                </div>
            </div>
            <div class="col-4">
                <div class="summary-box bg-spent">
                    <small style="opacity:0.9; font-size: 0.8rem;">‡πÉ‡∏ä‡πâ‡πÑ‡∏õ</small>
                    <div class="fw-bold mt-1" style="font-size: 0.9rem;" id="totalSpent">0</div>
                </div>
            </div>
            <div class="col-4">
                <div class="summary-box bg-remaining">
                    <small style="opacity:0.9; font-size: 0.8rem;">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</small>
                    <div class="fw-bold mt-1" style="font-size: 0.9rem;" id="totalRemaining">0</div>
                </div>
            </div>
        </div>

        <button class="main-add-btn mb-4" data-bs-toggle="modal" data-bs-target="#addExpenseModal">
            <i class="fas fa-plus-circle me-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô
        </button>

        <ul class="nav nav-pills nav-fill mb-3 bg-white p-1 rounded-pill shadow-sm" id="pills-tab">
            <li class="nav-item">
                <button class="nav-link active rounded-pill text-danger" data-bs-toggle="pill" data-bs-target="#tab-overview">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</button>
            </li>
            <li class="nav-item">
                <button class="nav-link rounded-pill text-danger" data-bs-toggle="pill" data-bs-target="#tab-history">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
            </li>
            <li class="nav-item">
                <button class="nav-link rounded-pill text-danger" data-bs-toggle="pill" data-bs-target="#tab-manage">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏ö</button>
            </li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="tab-overview">
                <div id="categoriesList"></div>
            </div>

            <div class="tab-pane fade" id="tab-history">
                <div class="card">
                    <div class="card-header bg-white text-danger fw-bold">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
                    <ul class="list-group list-group-flush" id="expensesHistory"></ul>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-manage">
                <div class="card">
                    <div class="card-header bg-white text-dark fw-bold">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏°‡πà</div>
                    <div class="card-body">
                        <div class="mb-2">
                            <label class="small text-muted">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                            <input type="text" class="form-control" id="newCatName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡πà‡∏≤‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà">
                        </div>
                        <div class="row mb-2">
                            <div class="col-6">
                                <label class="small text-muted">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                                <select class="form-select" id="newCatType">
                                    <option value="main">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏•‡∏±‡∏Å</option>
                                    <option value="sub">‡∏´‡∏°‡∏ß‡∏î‡∏¢‡πà‡∏≠‡∏¢</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="small text-muted">‡∏á‡∏ö (‡∏ö‡∏≤‡∏ó)</label>
                                <input type="number" class="form-control" id="newCatBudget" placeholder="0">
                            </div>
                        </div>
                        <div class="mb-3" id="parentCatGroup" style="display:none;">
                            <label class="small text-muted">‡∏≠‡∏¢‡∏π‡πà‡∏†‡∏≤‡∏¢‡πÉ‡∏ï‡πâ‡∏´‡∏°‡∏ß‡∏î</label>
                            <select class="form-select" id="newCatParent"></select>
                        </div>
                        <button class="btn btn-danger w-100 rounded-pill" id="btnAddCategory">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á</button>
                    </div>
                </div>

                <div class="card p-3">
                     <button class="btn btn-outline-secondary w-100 mb-2" id="btnCopyBudget">
                        <i class="fas fa-copy me-2"></i>‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏á‡∏ö‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß
                    </button>
                    <button class="btn btn-outline-danger w-100" id="btnReset">
                        <i class="fas fa-trash me-2"></i>‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addExpenseModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white"><h5 class="modal-title">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="mb-3 text-center">
                        <label class="text-muted small">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
                        <div class="input-group justify-content-center"><input type="number" class="form-control form-control-lg text-center text-danger fw-bold border-0" id="expenseAmount" placeholder="0" style="font-size: 2.5rem; background: #fdfdfd;" inputmode="decimal"></div>
                        <div class="text-muted small">‡∏ö‡∏≤‡∏ó</div>
                    </div>
                    <div class="mb-3"><label class="fw-bold small">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label><select class="form-select form-select-lg" id="expenseCategory" style="background-color: #f8f9fa;"></select></div>
                    <div class="mb-3"><label class="small text-muted">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label><input type="text" class="form-control" id="expenseDesc" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏Å‡∏∞‡∏î‡∏∂‡∏Å"></div>
                    <div class="mb-3"><label class="small text-muted">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" class="form-control" id="expenseDate"></div>
                    <button class="btn btn-danger w-100 py-3 rounded-pill fw-bold fs-5 shadow-sm" id="btnSaveExpense">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-light"><h5 class="modal-title">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body text-center py-4"><i class="fas fa-exclamation-circle text-warning fa-3x mb-3"></i><p class="mb-0 fs-5">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?</p><small class="text-muted">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ</small></div>
                <div class="modal-footer justify-content-center"><button type="button" class="btn btn-secondary px-4 rounded-pill" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="button" class="btn btn-danger px-4 rounded-pill" id="confirmDeleteBtn">‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editBudgetModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body"><input type="hidden" id="editCatId"><div class="mb-3"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label><input type="text" class="form-control" id="editCatName"></div><div class="mb-3"><label>‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</label><input type="number" class="form-control" id="editCatBudget"></div></div>
                <div class="modal-footer"><button type="button" class="btn btn-outline-danger me-auto" id="btnDeleteCat">‡∏•‡∏ö</button><button type="button" class="btn btn-primary" id="btnUpdateCat">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="menuModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title"><i class="fas fa-bars me-2"></i>‡πÄ‡∏°‡∏ô‡∏π‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="card p-3 mb-3 bg-white border shadow-sm">
                        <label class="fw-bold mb-2"><i class="fas fa-edit me-2"></i>‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="stationNameInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏±‡πä‡∏°‡∏•‡∏∏‡∏á‡∏°‡∏µ">
                            <button class="btn btn-primary" onclick="saveStationName()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                        <small class="text-muted mt-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏•‡∏ô‡πå</small>
                    </div>

                    <h6 class="text-muted mb-3">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ (One-Click Report)</h6>
                    <div class="d-grid gap-2 mb-4">
                        <button class="btn btn-report-line p-3 rounded-pill fw-bold" onclick="sendLineReport()">
                            <i class="fab fa-line fa-lg me-2"></i> ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏≤‡∏á LINE
                        </button>
                        <button class="btn btn-report-tg p-3 rounded-pill fw-bold" onclick="sendTelegramReport()">
                            <i class="fab fa-telegram fa-lg me-2"></i> ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏≤‡∏á Telegram
                        </button>
                    </div>

                    <hr>
                    <h6 class="text-muted mb-3">‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h6>
                    <button class="btn btn-outline-dark w-100 mb-2 p-2" id="btnExport">
                        <i class="fas fa-download me-2"></i>Backup ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå)
                    </button>
                    <button class="btn btn-outline-dark w-100 p-2" onclick="document.getElementById('fileImport').click()">
                        <i class="fas fa-upload me-2"></i>Restore ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô)
                    </button>
                    <input type="file" id="fileImport" style="display:none" accept=".json">
                    
                    <div class="text-center mt-4 text-muted small">
                        Budget System v2.6 (Pro Web Version)
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const initialCategories = [
            { id: 1, name: "Staff Cost", budget: 124170, parent: null, spent: 0 },
            { id: 2, name: "‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ", budget: 17372, parent: null, spent: 0 },
                { id: 21, name: "‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤", budget: 13722, parent: 2, spent: 0 },
                { id: 22, name: "‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏õ‡∏≤", budget: 2100, parent: 2, spent: 0 },
                { id: 23, name: "‡∏Ñ‡πà‡∏≤‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÅ‡∏•‡∏∞‡∏≠‡∏¥‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏ô‡∏ï", budget: 1450, parent: 2, spent: 0 },
                { id: 24, name: "‡∏Ñ‡πà‡∏≤‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏π‡∏îEDC", budget: 100, parent: 2, spent: 0 },
            { id: 3, name: "‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡πÜ", budget: 30333, parent: null, spent: 0 },
                { id: 31, name: "‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏á", budget: 2800, parent: 3, spent: 0 },
                { id: 32, name: "‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÅ‡∏ö‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå", budget: 1900, parent: 3, spent: 0 },
                { id: 33, name: "‡∏Ñ‡πà‡∏≤‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°", budget: 900, parent: 3, spent: 0 },
                { id: 34, name: "‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï", budget: 249, parent: 3, spent: 0 },
                { id: 35, name: "‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏Å‡∏£‡∏≠‡∏Å‡∏ñ‡∏±‡∏á", budget: 2324, parent: 3, spent: 0 },
                { id: 36, name: "‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏Ç‡∏ô‡∏™‡πà‡∏á", budget: 3000, parent: 3, spent: 0 },
                { id: 37, name: "‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏ó‡∏≥‡∏ö‡∏±‡∏ç‡∏ä‡∏µ", budget: 5000, parent: 3, spent: 0 },
                { id: 38, name: "‡∏Ñ‡πà‡∏≤‡∏†‡∏≤‡∏©‡∏µ‡πÅ‡∏•‡∏∞‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï", budget: 1008, parent: 3, spent: 0 },
                { id: 39, name: "‡∏Ñ‡πà‡∏≤‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏†‡∏±‡∏¢", budget: 1702, parent: 3, spent: 0 },
                { id: 40, name: "‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏ö‡πá‡∏î‡πÄ‡∏ï‡∏•‡πá‡∏î", budget: 1500, parent: 3, spent: 0 },
                { id: 41, name: "‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏´‡∏•‡∏∏‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ñ‡πà‡∏≤‡∏¢", budget: 8450, parent: 3, spent: 0 },
                { id: 42, name: "‡∏Ñ‡πà‡∏≤‡πÄ‡∏ü‡∏≠‡∏£‡πå‡∏ô‡∏¥‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô", budget: 1500, parent: 3, spent: 0 }
        ];

        let categories = [], expenses = [];
        let currentDate = new Date();
        let selectedMonth = currentDate.getMonth();
        let selectedYear = currentDate.getFullYear();
        let stationName = "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£"; 

        const monthNames = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
        let expenseToDeleteId = null, deleteModal = null;

        function init() {
            loadData();
            document.getElementById('expenseDate').valueAsDate = new Date();
            updateUI();
            deleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
        }
        function getKey() { return `ktp_budget_${selectedYear}_${selectedMonth}`; }
        function loadData() {
            const savedName = localStorage.getItem('ktp_budget_station_name');
            if(savedName) stationName = savedName;
            updateStationNameUI();

            const saved = localStorage.getItem(getKey());
            if (saved) {
                const d = JSON.parse(saved);
                categories = d.categories || [];
                expenses = d.expenses || [];
                if (categories.length === 0) categories = JSON.parse(JSON.stringify(initialCategories));
            } else {
                categories = JSON.parse(JSON.stringify(initialCategories));
                expenses = [];
            }
        }
        function saveData() { localStorage.setItem(getKey(), JSON.stringify({ categories, expenses })); updateUI(); }
        
        function saveStationName() {
            const name = document.getElementById('stationNameInput').value;
            if(name && name.trim() !== "") {
                stationName = name.trim();
                localStorage.setItem('ktp_budget_station_name', stationName);
                updateStationNameUI();
                alert('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö!');
            }
        }

        function updateStationNameUI() {
            document.getElementById('brandName').innerHTML = `<i class="fas fa-gas-pump me-2"></i>${stationName}`;
            document.title = stationName;
            document.getElementById('stationNameInput').value = stationName;
        }

        function updateUI() {
            document.getElementById('currentMonthYear').innerText = `${monthNames[selectedMonth]} ${selectedYear + 543}`;
            const totalBudget = categories.filter(c => c.parent === null).reduce((s, c) => s + (c.budget || 0), 0);
            const totalSpent = expenses.reduce((s, e) => s + e.amount, 0);
            document.getElementById('totalRemaining').innerText = (totalBudget - totalSpent).toLocaleString();
            document.getElementById('totalBudget').innerText = totalBudget.toLocaleString();
            document.getElementById('totalSpent').innerText = totalSpent.toLocaleString();
            renderCategories();
            renderHistory();
            updateDropdowns();
        }

        function generateReportText() {
            const dateStr = new Date().toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric' });
            let report = `üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏ö ${stationName}\nüìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dateStr}\n==================\n`;
            
            const mains = categories.filter(c => c.parent === null);
            let totalB = 0, totalS = 0;

            mains.forEach(m => {
                const subCats = categories.filter(c => c.parent === m.id);
                const relatedIds = [m.id, ...subCats.map(s => s.id)];
                const spent = expenses.filter(e => relatedIds.includes(e.categoryId)).reduce((s, e) => s + e.amount, 0);
                const remaining = m.budget - spent;
                
                totalB += m.budget;
                totalS += spent;

                report += `\nüîµ ${m.name} (‡∏á‡∏ö ${m.budget.toLocaleString()})\n`;
                report += `   üí∏‡πÉ‡∏ä‡πâ: ${spent.toLocaleString()} | ‚úÖ‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${remaining.toLocaleString()}\n`;

                subCats.forEach(s => {
                    const sSpent = expenses.filter(e => e.categoryId === s.id).reduce((sum, e) => sum + e.amount, 0);
                    const sRemaining = s.budget - sSpent;
                    report += `   ‚ñ´Ô∏è ${s.name}: ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${sRemaining.toLocaleString()}\n`;
                });
            });

            report += `\n==================\n`;
            report += `üí∞ ‡∏á‡∏ö‡∏£‡∏ß‡∏°: ${totalB.toLocaleString()}\n`;
            report += `üìâ ‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡∏£‡∏ß‡∏°: ${totalS.toLocaleString()}\n`;
            report += `üíµ ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: ${(totalB - totalS).toLocaleString()} ‡∏ö‡∏≤‡∏ó`;
            
            return report;
        }

        // --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Deep Link ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ iOS ‡∏Ñ‡πâ‡∏≤‡∏á ---
        window.sendLineReport = () => {
            const text = generateReportText();
            // ‡∏ß‡∏¥‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏≠‡∏õ LINE ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà
            window.location.href = 'line://msg/text/?' + encodeURIComponent(text);
        };

        window.sendTelegramReport = () => {
            const text = generateReportText();
            // ‡∏ß‡∏¥‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏≠‡∏õ Telegram ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà
            window.location.href = 'tg://msg?text=' + encodeURIComponent(text);
        };
        // ----------------------------------------

        function renderCategories() {
            const list = document.getElementById('categoriesList');
            list.innerHTML = '';
            if (categories.length === 0) return;
            const mains = categories.filter(c => c.parent === null);
            mains.forEach(m => {
                const subCats = categories.filter(c => c.parent === m.id);
                const relatedIds = [m.id, ...subCats.map(s => s.id)];
                const spent = expenses.filter(e => relatedIds.includes(e.categoryId)).reduce((s, e) => s + e.amount, 0);
                const remaining = m.budget - spent;
                const percent = m.budget > 0 ? (spent / m.budget) * 100 : 0;
                const isOver = spent > m.budget;
                const barClass = isOver ? 'bg-danger' : (percent > 90 ? 'bg-warning' : 'bg-success');
                const div = document.createElement('div');
                div.className = 'category-item';
                div.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-1" onclick="editCategory(${m.id})">
                        <div class="fw-bold fs-5">${m.name}</div>
                        <div class="text-end"><div style="font-size:0.8rem" class="text-muted">‡∏á‡∏ö ${m.budget.toLocaleString()} | ‡πÉ‡∏ä‡πâ ${spent.toLocaleString()}</div><div class="${remaining < 0 ? 'text-danger fw-bold' : 'text-success fw-bold'}">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${remaining.toLocaleString()}</div></div>
                    </div>
                    <div class="progress" style="height:8px;"><div class="progress-bar ${barClass}" style="width: ${Math.min(percent, 100)}%"></div></div>`;
                subCats.forEach(s => {
                    const sSpent = expenses.filter(e => e.categoryId === s.id).reduce((sum, e) => sum + e.amount, 0);
                    const sRemaining = s.budget - sSpent;
                    const sPercent = s.budget > 0 ? (sSpent / s.budget) * 100 : 0;
                    const sOver = sSpent > s.budget;
                    const sDiv = document.createElement('div');
                    sDiv.className = 'subcategory-item';
                    sDiv.innerHTML = `<div class="d-flex justify-content-between align-items-center" onclick="editCategory(${s.id})"><div><span>${s.name}</span></div><div class="text-end"><div style="font-size:0.75rem" class="text-muted">${sSpent.toLocaleString()} / ${s.budget.toLocaleString()}</div><div style="font-size:0.85rem" class="${sRemaining < 0 ? 'text-danger fw-bold' : 'text-success'}">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${sRemaining.toLocaleString()}</div></div></div><div class="progress mt-1" style="height:4px;"><div class="progress-bar ${sOver?'bg-danger':'bg-secondary'}" style="width: ${Math.min(sPercent, 100)}%"></div></div>`;
                    div.appendChild(sDiv);
                });
                list.appendChild(div);
            });
        }
        function renderHistory() {
            const list = document.getElementById('expensesHistory');
            list.innerHTML = '';
            const sorted = [...expenses].sort((a,b) => new Date(b.date) - new Date(a.date) || b.id - a.id);
            sorted.slice(0, 30).forEach(e => {
                const cat = categories.find(c => c.id === e.categoryId);
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `<div><div class="fw-bold text-dark">${e.description || (cat?cat.name:'-')}</div><small class="text-muted">${new Date(e.date).toLocaleDateString('th-TH')} ‚Ä¢ ${cat?cat.name:'-'}</small></div><div class="d-flex align-items-center"><span class="text-danger fw-bold me-3">-${e.amount.toLocaleString()}</span><div class="btn-delete-wrapper" onclick="askDelete(${e.id})"><i class="fas fa-trash-alt"></i></div></div>`;
                list.appendChild(li);
            });
        }
        function updateDropdowns() {
            const expSelect = document.getElementById('expenseCategory');
            const parentSelect = document.getElementById('newCatParent');
            expSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà --</option>';
            parentSelect.innerHTML = '';
            const mains = categories.filter(c => c.parent === null);
            mains.forEach(m => {
                expSelect.innerHTML += `<option value="${m.id}" class="fw-bold">üîµ ${m.name}</option>`;
                parentSelect.innerHTML += `<option value="${m.id}">${m.name}</option>`;
                categories.filter(c => c.parent === m.id).forEach(s => {
                    expSelect.innerHTML += `<option value="${s.id}"> &nbsp;&nbsp; ‚îî ${s.name}</option>`;
                });
            });
        }

        document.getElementById('prevMonth').onclick = () => changeMonth(-1);
        document.getElementById('nextMonth').onclick = () => changeMonth(1);
        function changeMonth(delta) { selectedMonth += delta; if(selectedMonth>11){selectedMonth=0;selectedYear++;} if(selectedMonth<0){selectedMonth=11;selectedYear--;} loadData(); updateUI(); }
        
        document.getElementById('btnSaveExpense').onclick = () => {
            const amt = parseFloat(document.getElementById('expenseAmount').value);
            const catId = parseInt(document.getElementById('expenseCategory').value);
            const desc = document.getElementById('expenseDesc').value;
            const date = document.getElementById('expenseDate').value;
            if(!amt || !catId || !date) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
            expenses.push({ id: Date.now(), categoryId: catId, amount: amt, description: desc, date: date });
            saveData();
            bootstrap.Modal.getInstance(document.getElementById('addExpenseModal')).hide();
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseDesc').value = '';
        };
        
        window.askDelete = (id) => { expenseToDeleteId = id; deleteModal.show(); };
        document.getElementById('confirmDeleteBtn').onclick = () => { if (expenseToDeleteId) { expenses = expenses.filter(e => e.id !== expenseToDeleteId); saveData(); deleteModal.hide(); expenseToDeleteId = null; } };
        document.getElementById('newCatType').onchange = function() { document.getElementById('parentCatGroup').style.display = (this.value==='sub')?'block':'none'; };
        document.getElementById('btnAddCategory').onclick = () => {
            const name = document.getElementById('newCatName').value;
            const budget = parseFloat(document.getElementById('newCatBudget').value) || 0;
            const type = document.getElementById('newCatType').value;
            const parent = (type==='sub') ? parseInt(document.getElementById('newCatParent').value) : null;
            if(!name) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà');
            const newId = categories.length>0 ? Math.max(...categories.map(c=>c.id))+1 : 1;
            categories.push({id:newId, name, budget, parent, spent:0}); saveData(); alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            document.getElementById('newCatName').value = ''; document.getElementById('newCatBudget').value = '';
        };
        window.editCategory = (id) => { const c = categories.find(x=>x.id===id); if(!c) return; document.getElementById('editCatId').value = id; document.getElementById('editCatName').value = c.name; document.getElementById('editCatBudget').value = c.budget; new bootstrap.Modal(document.getElementById('editBudgetModal')).show(); };
        document.getElementById('btnUpdateCat').onclick = () => { const id = parseInt(document.getElementById('editCatId').value); const idx = categories.findIndex(c=>c.id===id); if(idx!==-1) { categories[idx].name = document.getElementById('editCatName').value; categories[idx].budget = parseFloat(document.getElementById('editCatBudget').value) || 0; saveData(); bootstrap.Modal.getInstance(document.getElementById('editBudgetModal')).hide(); } };
        document.getElementById('btnDeleteCat').onclick = () => { const id = parseInt(document.getElementById('editCatId').value); if(categories.some(c=>c.parent===id)) return alert('‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏¢‡πà‡∏≠‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö'); if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ?')) { categories = categories.filter(c=>c.id!==id); saveData(); bootstrap.Modal.getInstance(document.getElementById('editBudgetModal')).hide(); } };
        document.getElementById('btnCopyBudget').onclick = () => { let pm=selectedMonth-1, py=selectedYear; if(pm<0){pm=11;py--;} const pData = localStorage.getItem(`ktp_budget_${py}_${pm}`); if(pData && confirm('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏á‡∏ö‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤?')) { const d = JSON.parse(pData); categories = d.categories.map(c=>({...c, spent:0})); expenses = []; saveData(); alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); } else if (!pData) alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤'); };
        document.getElementById('btnReset').onclick = () => { if(confirm('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) { categories=[]; expenses=[]; saveData(); } };
        document.getElementById('btnExport').onclick = () => { const blob = new Blob([JSON.stringify({categories,expenses})], {type:"application/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `ktp_budget_${selectedYear}_${selectedMonth+1}.json`; a.click(); };
        document.getElementById('fileImport').onchange = (e) => { const f = e.target.files[0]; if(!f)return; const r = new FileReader(); r.onload = (e) => { try { const d = JSON.parse(e.target.result); if(confirm('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?')) { categories=d.categories; expenses=d.expenses; saveData(); alert('‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'); } } catch(err){alert('‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');} }; r.readAsText(f); };
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>
